
@{
    ViewBag.Title = "发布需求";
    Layout = null;
}
<link href="/Content/layui/css/layui.css" rel="stylesheet" />
<style type="text/css">
    .post-comment .pull-left img {
        margin-right: 20px;
        /*border-left: 3px solid #0884d5;*/
    }

    .about-btn {
        max-width: inherit;
        background: #f2f2f2;
    }
    /*下拉框弹出高度*/
    .layui-form-select dl {
        max-height: 160px;
    }
    /*性别外框*/
    .layui-form-pane .layui-form-item[pane] {
        max-width: 300px;
    }
    /*提交按钮*/
    .layui-btn {
        /*width: 50%;*/
        background-color: #ff6a00;
        /*margin-left: 42%;*/
    }
    /*时间选中颜色*/
    .layui-laydate .layui-this {
        background-color: #2b96cc !important;
    }
    /*下拉框选中颜色*/
    .layui-form-select dl dd.layui-this {
        background-color: #2b96cc;
    }
    /*单选选中颜色*/
    .layui-form-radio > i:hover, .layui-form-radioed > i {
        color: #2b96cc;
    }

    .layui-btn {
        width: 50%;
        background-color: #ff6a00;
        margin-left: 42%;
    }

    .layui-form-item {
        margin-bottom: 15px;
    }
</style>
<div class="col-md-12 col-sm-12">
    <div class="main" style="margin-top: 0">
        @*<h2>需求发布</h2>*@
        <div class="about-btn" style="margin-top:0;">
            <form class="layui-form layui-form-pane" action="" style="padding:5% 12%;" lay-filter="example">
                <div class="layui-form-item">
                    <label class="layui-form-label">订单类别</label>
                    <div class="layui-input-block">
                        <select name="OrderType" id="OrderType" lay-filter="aihao">
                            <option value="1">共享保姆/课后托管照护</option>
                            <option value="2">婴幼照护</option>
                            <option value="3">养老照护</option>
                            <option value="4" selected="">孕产照护</option>

                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">标题</label>
                    <div class="layui-input-block">
                        <input type="text" name="ordertitle" lay-verify="required" placeholder="请输入需求标题" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">您的情况</label>
                    <div class="layui-input-block">
                        <select name="PersonInro" id="PersonInro" lay-filter="aihao">
                            <option value="失能">失能</option>
                            <option value="半失能">半失能</option>
                            <option value="健康" selected="">健康</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">现住址</label>
                    <div class="layui-input-block">
                        <input type="text" name="Address" placeholder="请输入居住地址" lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">现住址</label>
                    <div class="layui-input-inline" style="width:100px;">
                        <select name="provid" id="provid4" lay-filter="provid">
                            <option value="">请选择省</option>
                        </select>
                    </div>
                    <div class="layui-input-inline" style="width:100px;">
                        <select name="cityid" id="cityid4" lay-filter="cityid">
                            <option value="">请选择市</option>
                        </select>
                    </div>
                    <div class="layui-input-inline" style="width:120px;">
                        <select name="areaid" id="areaid4" lay-filter="areaid">
                            <option value="">请选择县/区</option>
                        </select>
                    </div>
                    <div class="layui-input-inline" style="width:322px;margin:5px 0;">
                        <input type="text" class="layui-input" name="Address" lay-verify="required" placeholder="详细地址" />
                    </div>
                </div>
                <div class="layui-form-item" id="parttime">
                    <label class="layui-form-label">照护日期</label>
                    <div class="layui-input-block">
                        <input type="text" class="layui-input" name="CeraRange" lay-verify="required" id="CeraRange" placeholder=" 照护起止日期范围">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">日照护方式</label>
                    <div class="layui-input-block">
                        <select name="DateType" id="DateType" lay-filter="aihao">
                            <option value="4h(半天)">4h(半天)</option>
                            <option value="10h(白天)">10h(白天)</option>
                            <option value="24h(全天)" selected="">24h(全天)</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">照护地点</label>
                    <div class="layui-input-block">
                        <select name="CareAddress" id="CareAddress" lay-filter="aihao">
                            <option value="居家">居家</option>
                            <option value="定点社区">定点社区</option>
                            <option value="机构养老" selected="">机构养老</option>
                            <option value="旅游养老">旅游养老</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">照护人数</label>
                    <div class="layui-input-block">
                        <select name="CarePerson" id="CarePerson" lay-filter="aihao">
                            <option value="1人" selected="">1人</option>
                            <option value="2人">2人</option>
                            <option value="3人">3人</option>
                            <option value="4人">4人</option>
                            <option value="5人">5人</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">简介</label>
                    <div class="layui-input-block">
                        <textarea placeholder="请输入其他需求(可为空)" name="memo" class="layui-textarea" style="width:322px;max-height:60px;"></textarea>
                    </div>
                </div>

                <!--视频上传/PBook/AddPBook-->
                <div class="layui-form-item layui-form-text" style="display:none;">
                    <label class="layui-form-label">视频文件</label>
                    <div class="layui-input-inline  layui-upload-drag" id="videoList" style="width:230px;">
                        <i class="layui-icon layui-icon-add-1" id="shipin" style="color:#d7d7d7;"></i>
                        @*<p>点击上传，或将文件拖拽到此处</p>*@
                        <video class="layui-upload-img" id="demo2" style="display:none;width:100%;"></video>
                    </div>
                    <p id="errorVideo"></p>
                    <input type="hidden" value="" name="VideoUrl" id="VideoUrl" />
                    <!--上传视频进度条-->
                    <div class="layui-form-mid layui-word-aux layui-progress layui-progress-big" lay-filter="videoProgress" lay-showPercent="true">
                        (上传视频，支持格式mp4）
                        <br />
                        <div class="layui-progress-bar layui-bg-red" lay-percent="0%"></div>
                    </div>
                </div>
                <!--图片上传-->
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">图片上传</label>
                    <div class="layui-input-inline  layui-upload-drag" id="ImgList" style="width:150px;margin-top:10px;">
                        <i class="layui-icon layui-icon-add-1" id="jiahao" style="color:#d7d7d7;"></i>
                        @*<p>点击上传，或将文件拖拽到此处</p>*@
                        <img class="layui-upload-img" id="demo1" style="display:none;width:150px;">
                    </div>
                    <div class="layui-form-mid layui-word-aux">（上传图片,建议尺寸:150*200,大小不超过2M,支持格式jpg|png|gif|bmp|jpeg）</div>
                    <p id="errorImg"></p>
                    <input type="hidden" value="" name="ImgUrl" id="ImgUrl" />
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">需求描述</label>
                    <div class="layui-input-block" style="background:#fff;">
                        <textarea class="layui-textarea layui-hide" name="content" lay-verify="content" placeholder="请输入内容" id="Article_editor" autocomplete="off"></textarea>

                    </div>
                </div>


                <div class="layui-form-item">
                    <button class="layui-btn" lay-submit="" id="tijiaoData" lay-filter="save">提交需求</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="http://www.jq22.com/jquery/jquery-1.10.2.js"></script>

@*<script src="/Scripts/jquery-1.10.2.min.js"></script>*@
<script src="/Content/layui/layui.js"></script>
<script src="~/Content/js/data.js"></script>
<script src="~/Content/js/province.js"></script>
<script>
    //省市县三级联动
    var defaults = {
        s1: 'provid',
        s2: 'cityid',
        s3: 'areaid',
        v1: null,
        v2: null,
        v3: null
    };
    //页面加载--导航菜单设置选中状态
     var type ="@(ViewBag.typenew)";
    $(function () {

        //验证登录
        //if (!is_login()) {
        //    layui.use('layer', function () {
        //        var layer = layui.layer;
        //        layui.layer.confirm('您尚未登录,即将跳转登录页面！', function (index) {
        //            if (type == "1") {
        //                parent.location.href = "/Home/Login/?ReturnUrl=/Demand/ClassCare/";
        //            } else if (type == "2") {
        //                parent.location.href = "/Home/Login/?ReturnUrl=/Demand/InfantCare/";
        //            } else if (type == "3") {
        //                parent.location.href = "/Home/Login/?ReturnUrl=/Demand/OldAgeCare/";
        //            } else {
        //                parent.location.href = "/Home/Login/?ReturnUrl=/Demand/GravidaCare/";
        //            }
        //            layer.close(index);
        //        });
        //    });
        //}

    });

    //发布需求
    layui.use(['form', 'layedit', 'layer', 'upload', 'laydate'], function () {
        var $ = layui.jquery
            , upload = layui.upload
            , form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate;

        //表单初始赋值
        form.val('example', {
            "OrderType": type // "name": "value"

        });



        //日期
        laydate.render({
            elem: '#date'
            , type: 'year'
        });
        //时间范围
        laydate.render({
            elem: '#CeraRange'
            //, type: 'time'
            , range: true
        });

        //插入图片接口
        layedit.set({
            uploadImage: {
                url: '/User/UploadImg/' //接口url
                , type: 'post' //默认post
                , xhr: xhrOnProgress
                , progress: function (value) {//上传进度回调 value进度值
                    element.progress('demoeidt', value + '%')//设置页面进度条
                }
            }
        });

        //创建一个编辑器
        var editIndex = layedit.build('Article_editor', {
            tool: [
                'strong' //加粗
                , 'italic' //斜体
                , 'underline' //下划线
                , 'del' //删除线
                , '|' //分割线
                , 'left' //左对齐
                , 'center' //居中对齐
                , 'right' //右对齐
                , 'image' //插入图片
                , 'face'
            ]
        });
        //自定义验证规则
        form.verify({
            content: function () {
                var value = layedit.getContent(editIndex);
                if (value == "") {

                    return '内容不能为空!';
                }
                layedit.sync(editIndex);//用于同步编辑器内容到textarea（一般用于异步提交）
            }
        });
        //监听提交
        form.on('submit(save)', function (data) {

            $.ajax({
                type: "POST",
                url: "/Demand/SetOwnNeedData",
                data: {
                    //"totalData": JSON.stringify(data.field)
                    "PersonInro": data.field.PersonInro,//被照护人情况
                    "Address": data.field.Address,
                    "CeraRange": data.field.CeraRange,//照护起止日期
                    "DateType": data.field.DateType,//照护方式  如：4H（半天）、10h(白天)、24h（全天）
                    "CarePerson": data.field.CarePerson,//照护人数
                    "CareAddress": data.field.CareAddress,
                    "Title": data.field.ordertitle,
                    "Memo": data.field.memo,
                    "VideoUrl": data.field.VideoUrl,
                    "ImgUrl": data.field.ImgUrl,

                    "OrderClassify": data.field.OrderType,
                    "OrderType": $("#OrderType option:selected").text(),
                    "OrderIntro": data.field.content
                },
                dataType: "json",
                success: function (res) {

                    if (res.Statu == 1) {
                        layer.alert(res.Msg, { skin: 'layui-layer-molv' }, function (index) {
                            parent.location.href = res.BackUrl;
                            layer.close(index)
                        });

                    } else {
                        layer.alert(res.Msg, { skin: 'layui-layer-molv' });
                        //layer.closrAll();
                    }
                }
            });
            return false;
        });

    });

    //上传图片/视频
    layui.use(['form', 'layedit', 'layer', 'upload', 'element'], function () {
        var form = layui.form
            , upload = layui.upload
            , layer = layui.layer
            , layedit = layui.layedit
            , element = layui.element;
        //单个图片上传
        var uploadInst = upload.render({
            elem: '#ImgList'
            , url: '/User/UploadImgData/'
            , method: 'POST'
            , accept: 'images'
            , xhr: xhrOnProgress
            , progress: function (value) {//上传进度回调 value进度值
                element.progress('demoimg', value + '%')//设置页面进度条
            }
            //, bindAction: '#testListAction'
            , choose: function (obj) {

                obj.preview(function (index, file, result) {

                    $('#demo1').attr('src', result); //图片链接（base64）
                });
            }
            , data: {

            }
            , before: function (obj) {

            }
            , done: function (res, index, upload) {

                if (res.Statu == 1) { //上传成功

                    //parent.location.href = res.BackUrl;
                    $("#demo1").css("display", "block");
                    $("#jiahao").css("display", "none");
                    $('#demo1').attr('src', res.Data);
                    $('#ImgUrl').val(res.Data);
                    layer.closeAll();
                } else {
                    layer.alert(res.Msg);
                    return false;

                }

            }
            , error: function (index, upload) {

                var demoText = $('#errorImg');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</ a>');
                demoText.find('.demo-reload').on('click', function () {
                    uploadInst.upload();
                });
            }
        });
        //视频
        var uploadVideo = upload.render({
            elem: '#videoList'
            , url: '/User/UploadVideoData/'
            , method: 'POST'
            , accept: 'video'
            //, exts: 'mp4|'
            , xhr: xhrOnProgress
            , progress: function (value) {//上传进度回调 value进度值
                element.progress('videoProgress', value + '%')//设置页面进度条
            }
            //, bindAction: '#testListAction'
            , choose: function (obj) {

                obj.preview(function (index, file, result) {

                    $('#demo2').attr('src', result); //图片链接（base64）
                });
            }
            , data: {

            }
            , before: function (obj) {

            }
            , done: function (res, index, upload) {

                if (res.Statu == 1) { //上传成功

                    //parent.location.href = res.BackUrl;
                    $("#demo2").css("display", "block");
                    $("#shipin").css("display", "none");
                    $('#demo2').attr('src', res.Data);
                    $('#VideoUrl').val(res.Data);
                    layer.closeAll();
                } else {
                    layer.alert(res.Msg);
                    return false;

                }

            }
            , error: function (index, upload) {

                var demoText = $('#errorVideo');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</ a>');
                demoText.find('.demo-reload').on('click', function () {
                    uploadVideo.upload();
                });
            }
        });

    });

    //创建监听函数
    var xhrOnProgress = function (fun) {
        xhrOnProgress.onprogress = fun; //绑定监听
        //使用闭包实现监听绑
        return function () {
            //通过$.ajaxSettings.xhr();获得XMLHttpRequest对象
            var xhr = $.ajaxSettings.xhr();
            //判断监听函数是否为函数
            if (typeof xhrOnProgress.onprogress !== 'function')
                return xhr;
            //如果有监听函数并且xhr对象支持绑定时就把监听函数绑定上去
            if (xhrOnProgress.onprogress && xhr.upload) {
                xhr.upload.onprogress = xhrOnProgress.onprogress;
            }
            return xhr;
        }
    }

    //判断当前是否登录
    function is_login() {
        var login = '@Request.IsAuthenticated';
        if (login == "False") {
            return false;
        } else {
            return true;
        }
    }
</script>